# Nuxt SaaS CMS starter

Эта документация -- сугубо предварительная. По плану, она будет сначала дополняться и доводиться до нормального состояния на русском языке, а потом будет переведена. Русская версия будет вынесена в отдельный файл. Ну и/или на сайт проекта, если до этого дойдет дело.

## TL;DR

Это шаблон (boilerplate) для быстрого разворачивания SaaS-приложения (или CMS) на базе Nuxt 3. Основной принцип -- "чем проще, тем лучше".

Что в комплекте (есть/будет):

* Авторизация/аутентификация из коробки
* TODO: Разные способы входа/регистрации
* TODO: Готовый подход к редактированию данных
* TODO: Минимальный набор компонентов, composables и middleware для всего этого
* TODO: Максимальная документированность при минимальном объеме документации

Авторизация сделана с помощью Lucia Auth.

## Как установить и проверить эту дичь

1) Смотрим файл `compose.yml` (есть в репе). Корректируем его по своему усмотрению. По умолчанию разворачивается MariaDB для хранения учеток пользователей и их сессий. Выполняем `docker compose up` -- поднимается БД.

2) Сборка использует Prisma ORM. Поэтому для создания подключения к БД нам нужно создать переменную окружения `DATABASE_URL` и присвоить ей правильное значение (url специального вида). Создаем файл `.env`, записываем в него нечно подобное:
    ```
    # Prisma ORM connection string
    DATABASE_URL="mysql://root:f!fI4@dkowEj4@localhost:3306/nsc_starter"
    ```
3) Делаем `npm i` в каталоге приложения
4) Выполняем `npx prisma migrate dev --name init` -- это инициализирует Prisma, создает нужные таблицы в БД. Схема таблиц лежит в файле `/prisma/schema.prisma` (для любознательных)
5) Открываем в браузере `/auth/login`. Если работает -- переходим к регистрации (`/auth/signup`), заводим новый аккаунт. В dev-режиме письма со ссылками подтверждения и т.п. сохраняются в каталоге `/_tmp/mail`.

## Выглядит как WEB 0.5?

Так и должно быть! Зачем вам наши стили? Мы, конечно, добавили пару стилей, чтоб на экране вообще можно было что-то понять. Но удалить их -- дело двух минут.

Как это сделать?

В проекте используются layouts. Для страниц связанных с процессом авторизации/регистрации используется файл `/layouts/auth-pages`. Стилизуем его как угодно: tailwind, SCSS, что установите -- то и используйте. Сами страницы лежат в `/pages/auth`. Внутри этих страниц используется один и тот же подход. Распишем его позже. Также используется один предустановленный компонент: `/components/Auth/Form.vue`. Разбираемся в нем (он прост как топор) и стилизуем его как надо.

В процессе регистрации/восстановления пароля пользователь редиректится на страницы вида `/message?type=XXX&code=XXX`. Это страница для вывода сообщений. Страница находится в файле `/pages/message.vue` и использует макет `/layouts/message-pages.vue`. Для стилизации подобных страниц редактируем эти файлы.

## Как разлогиниться

Еще один сделанный нами компонент -- `/components/Auth/Logout.vue`. Можно обернуть в него что угодно и это будет кнопка выхода. Как работает выход -- можно понять из устройства этого компонента (он до крайности примитивен и понятен).

## Другие важные файлы
* `/middleware/auth.global.ts`, `/server/middleware/auth.ts`, `/server/utils/auth.ts` -- файлы связанные с работой Lucia
* `/middleware/no-auth-only.ts` -- middleware для страниц. Если подключить его к странице -- она будет доступна только для неавторизовнанных пользователей. В противном случае пользователь будет перенаправлен на главную страницу. Этот middleware применятеся на страницах логина/регистрации и т. д. Зачем они авторизованных пользователей?
* `/middleware/protected.ts` -- middleware для страниц. Страницы с этим middleware доступны только для авторизованных пользователей

## Еще немного интересного

В файле `/server/api/v1/demo/test.get.ts` есть пример как в ваших API отличать авторизованных пользователей от неавторизованных.

API-эндпоинты связанные с процессами авторизации/регистрации находятся в каталоге `/server/api/v1/auth`.

Для валидации данных предлагается использовать один и тот же механизм, что на страницах, что в файлах эндпоинтов. Пример реализации находится в файле `/utils/dataValidation.ts`. Функция оттуда используется как в формах страниц авторизации/регистрации, так и в API-эндпоинтах из `/server/api/v1/auth`. Разумеется, саму проверку можно проводить другими способами вроде Joi и т. п. на свое усмотрение.

Шаблоны писем находятся в `/emails`. Для получения шаблонов писем используется `@vue-email/nuxt`. Отправка писем происходит с помощью класса EmailSender из `/utils/emailSender.ts`. Базово в нем реализована только отправка писем в каталог `/_tmp/mail` и дан пример отправки через Postmark (он закомментирован).